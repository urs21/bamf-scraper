#-------------------------------------------------------------------------------
# BAMF Integration Course Finder with Interactive Leaflet Map
#-------------------------------------------------------------------------------

#— 0. Load only the packages we actually need ----------------------------------
library(dplyr)    # data manipulation
library(tidyr)    # unnest_wider()
library(sf)       # spatial operations
library(httr)     # GET(), accept_json()
library(tidyverse)

#— I. Read precomputed grid & build coord list ---------------------------------
# adjust this path to wherever you saved your RDS file 
path <- "C:/Users/khalil/OneDrive - DeZIM-Institut e.V/01_Projekte/12_Scrape_BAMF"

# Enter Search coordinates
coords <- matrix(
  c(
    383871.075066598, 5270420.05625528,
    452871.075066598, 5270420.05625528,
    521871.075066598, 5270420.05625528,
    590871.075066598, 5270420.05625528,
    659871.075066598, 5270420.05625528,
    728871.075066598, 5270420.05625528,
    797871.075066598, 5270420.05625528,
    383871.075066598, 5339420.05625528,
    452871.075066598, 5339420.05625528,
    521871.075066598, 5339420.05625528,
    590871.075066598, 5339420.05625528,
    659871.075066598, 5339420.05625528,
    728871.075066598, 5339420.05625528,
    797871.075066598, 5339420.05625528,
    866871.075066598, 5339420.05625528,
    314871.075066598, 5408420.05625528,
    383871.075066598, 5408420.05625528,
    452871.075066598, 5408420.05625528,
    521871.075066598, 5408420.05625528,
    590871.075066598, 5408420.05625528,
    659871.075066598, 5408420.05625528,
    728871.075066598, 5408420.05625528,
    797871.075066598, 5408420.05625528,
    866871.075066598, 5408420.05625528,
    314871.075066598, 5477420.05625528,
    383871.075066598, 5477420.05625528,
    452871.075066598, 5477420.05625528,
    521871.075066598, 5477420.05625528,
    590871.075066598, 5477420.05625528,
    659871.075066598, 5477420.05625528,
    728871.075066598, 5477420.05625528,
    797871.075066598, 5477420.05625528,
    314871.075066598, 5546420.05625528,
    383871.075066598, 5546420.05625528,
    452871.075066598, 5546420.05625528,
    521871.075066598, 5546420.05625528,
    590871.075066598, 5546420.05625528,
    659871.075066598, 5546420.05625528,
    728871.075066598, 5546420.05625528,
    797871.075066598, 5546420.05625528,
    314871.075066598, 5615420.05625528,
    383871.075066598, 5615420.05625528,
    452871.075066598, 5615420.05625528,
    521871.075066598, 5615420.05625528,
    590871.075066598, 5615420.05625528,
    659871.075066598, 5615420.05625528,
    728871.075066598, 5615420.05625528,
    797871.075066598, 5615420.05625528,
    866871.075066598, 5615420.05625528,
    935871.075066598, 5615420.05625528,
    314871.075066598, 5684420.05625528,
    383871.075066598, 5684420.05625528,
    452871.075066598, 5684420.05625528,
    521871.075066598, 5684420.05625528,
    590871.075066598, 5684420.05625528,
    659871.075066598, 5684420.05625528,
    728871.075066598, 5684420.05625528,
    797871.075066598, 5684420.05625528,
    866871.075066598, 5684420.05625528,
    935871.075066598, 5684420.05625528,
    314871.075066598, 5753420.05625528,
    383871.075066598, 5753420.05625528,
    452871.075066598, 5753420.05625528,
    521871.075066598, 5753420.05625528,
    590871.075066598, 5753420.05625528,
    659871.075066598, 5753420.05625528,
    728871.075066598, 5753420.05625528,
    797871.075066598, 5753420.05625528,
    866871.075066598, 5753420.05625528,
    935871.075066598, 5753420.05625528,
    314871.075066598, 5822420.05625528,
    383871.075066598, 5822420.05625528,
    452871.075066598, 5822420.05625528,
    521871.075066598, 5822420.05625528,
    590871.075066598, 5822420.05625528,
    659871.075066598, 5822420.05625528,
    728871.075066598, 5822420.05625528,
    797871.075066598, 5822420.05625528,
    866871.075066598, 5822420.05625528,
    935871.075066598, 5822420.05625528,
    383871.075066598, 5891420.05625528,
    452871.075066598, 5891420.05625528,
    521871.075066598, 5891420.05625528,
    590871.075066598, 5891420.05625528,
    659871.075066598, 5891420.05625528,
    728871.075066598, 5891420.05625528,
    797871.075066598, 5891420.05625528,
    866871.075066598, 5891420.05625528,
    314871.075066598, 5960420.05625528,
    383871.075066598, 5960420.05625528,
    452871.075066598, 5960420.05625528,
    521871.075066598, 5960420.05625528,
    590871.075066598, 5960420.05625528,
    659871.075066598, 5960420.05625528,
    728871.075066598, 5960420.05625528,
    797871.075066598, 5960420.05625528,
    866871.075066598, 5960420.05625528,
    383871.075066598, 6029420.05625528,
    452871.075066598, 6029420.05625528,
    521871.075066598, 6029420.05625528,
    590871.075066598, 6029420.05625528,
    659871.075066598, 6029420.05625528,
    728871.075066598, 6029420.05625528,
    797871.075066598, 6029420.05625528,
    866871.075066598, 6029420.05625528,
    452871.075066598, 6098420.05625528,
    521871.075066598, 6098420.05625528,
    590871.075066598, 6098420.05625528,
    797871.075066598, 6098420.05625528
  ),
  ncol = 2,
  byrow = TRUE
) %>% as_tibble()

coord_list <- paste0(coords$V1, ",", coords$V2)

#— II. Scrape course listings ---------------------------------------------
endpoint    <- "https://bamf-navi.bamf.de/atlas-backend/kurse"
course_list <- vector("list", length(coord_list))

for (i in seq_along(coord_list)) {
  res    <- GET(endpoint, query = list(coord = coord_list[i]), accept_json())
  parsed <- content(res, as = "parsed")
  
  course_list[[i]] <- bind_rows(parsed) %>%
    mutate(
      loop  = i,
      coord = coord_list[i])
  
  message(sprintf("Listing %d/%d (%.1f%%)",
                  i, length(coord_list), i/length(coord_list)*100))
}

# bind into one data.frame
df_raw <- bind_rows(course_list)

#— III. Unnest offerings & dedupe -------------------------------------------
df <- df_raw %>%
  unnest_wider(angebot) %>%
  group_by(id) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  distinct(id, .keep_all = TRUE) %>%
  arrange(id)  %>%
  mutate(scraping_time = Sys.time())

#— V. Course statistics ----------------------------------------------------
as_tibble(df)

# define your mapping
levels_kursart <- c(1, 4, 5, 6, 7, 8, 21, 13, 9, 19, 23)
labels_kursart <- c(
  "Allgemeiner Integrationskurs",
  "Integrationskurs mit Alphabetisierung",
  "Gehörlosenkurs",
  "Elternintegrationskurs",
  "Frauenintegrationskurs",
  "Förderkurs",
  "Blindenkurs",
  "Sonstiger spezieller Kurs",
  "Intensivkurs",
  "Zweitschriftlernerkurs",
  "Geringliteralisiertenkurs"
)

levels_zeit <- c(1, 2, 3, 4, 6, 7)
labels_zeit <- c(
  "Vormittags",
  "Nachmittags",
  "Vormittags/nachmittags",
  "Abends",
  "Nachmittags/abends",
  "Wechselnd je nach Wochentag"
)

# recode as factor
df <- df %>%
  mutate(
    kursartId = factor(
      kursartId,
      levels = levels_kursart,
      labels = labels_kursart
    ),
    unterrichtszeitenId = factor(
      unterrichtszeitenId,
      levels = levels_zeit,
      labels = labels_zeit
    )
  )

as_tibble(df[,10:11])

# Base R
df <- df %>%
  mutate(
    beginn = as.Date(beginn, format = "%d.%m.%y"),
    ende   = as.Date(ende,   format = "%d.%m.%y")
  )

# Reduce
df <- df %>% select(-adrZusatz, -count, -zusatzKompas, -zusatzVergabe)

# Save
df %>% write_rds(paste0("bamf_courses_", format(Sys.time(), "%Y-%m-%d_%H-%M-%S"), ".rds"))